# Product Validation in Order Management

This document describes the implementation of product validation in the Order Management service, including the contract testing setup with Pact.

## Overview

The Order Management service needs to validate that products exist in the Inventory Management service before they can be added to orders. This ensures data integrity and prevents orders containing invalid products.

## Implementation

### Components

1. **InventoryClient**: Feign client to interact with the Inventory Management service
2. **ProductValidationService**: Service to validate products exist in inventory
3. **OrderService**: Updated to validate products during order creation and updates

### Flow

1. When an order is created or updated, the product IDs are extracted
2. The `ProductValidationService` checks each product ID with the Inventory Management service
3. If any product doesn't exist, an `InvalidOrderException` is thrown
4. If all products exist, the order operation continues

## Contract Testing with Pact

Instead of integration tests requiring the actual Inventory Management service, we use Pact for consumer-driven contract testing.

### Consumer Tests

The `InventoryServicePactTest` defines the contract that Order Management (consumer) expects from Inventory Management (provider):

1. **Existing Product Test**: Verifies we can retrieve details of an existing product
2. **Non-existent Product Test**: Verifies we receive a 404 error for non-existent products

### Pact Matchers

The consumer tests use Pact matchers to make the contracts more flexible:

1. **Type Matchers**: Ensure fields have the right data type (e.g., `numberType`, `stringType`)
2. **Regex Matchers**: Validate string formats like timestamps using regular expressions
3. **Example Values**: Each matcher includes example values for clear documentation

Using matchers creates more resilient contracts that won't break when non-critical details change, such as the exact text of an error message or the specific timestamp format.

### Pact Contract Generation

Running the Pact consumer tests generates contract files in the `pacts` directory, which:
1. Define the expected request/response format
2. Specify provider states required for testing
3. Document the API subset used by Order Management

### Provider Verification

The Inventory Management service can verify it meets the contract by:
1. Reading the contract files generated by Order Management
2. Setting up provider states (e.g., "a product with ID 42 exists")
3. Running the requests specified in the contract against the actual API
4. Verifying responses match the expectations in the contract

## Error Handling

The product validation includes robust error handling:

1. **Missing Products**: Clear error message indicating which products don't exist
2. **Service Unavailability**: Graceful handling of temporary Inventory service outages
3. **Network Issues**: Appropriate logging and fallback behavior

## Configuration

The Inventory service URL is configurable via properties:

```properties
# Default (local development)
inventory.service.url=http://localhost:8081

# Production configuration would be set in application-prod.properties
inventory.service.url=http://inventory-service:8080
```

## Testing

Several test types ensure the implementation works correctly:

1. **Unit Tests**: Testing the validation logic in isolation
2. **Consumer Pact Tests**: Defining the expected contract with Inventory service
3. **OrderService Tests**: Verifying the integration of validation into order flows

## Running the Tests

To run the Pact consumer tests:

```bash
./gradlew test --tests cargo.kityk.wms.test.order.contract.InventoryServicePactTest
```

This will generate the Pact contract files in `build/pacts` directory.

## Deployment Considerations

In production, both services need to be deployed and configured correctly:

1. **Order Management** needs the correct Inventory service URL
2. **Inventory Management** needs to implement the API as specified in the contract
3. **Zero Trust**: All service-to-service communication should use authentication in production 