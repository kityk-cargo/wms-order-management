# Pact Contract Verification

This document describes how to run the Pact contract verification tests for the Order Management service.

## Overview

The Order Management service uses [Pact](https://pact.io/) for consumer-driven contract testing. The service verifies that it can fulfill the expectations set by its consumers (like the UI application).

Our implementation:
1. Uses a test-based approach with JUnit 5 (not the Gradle plugin approach)
2. Loads Pact files from the filesystem (not from a Pact Broker)
3. Integrates with TestContainers for database testing
4. Reuses the existing Liquibase configuration from wms-main

## Running Pact Verification Locally

To run the Pact verification tests locally:

```bash
./gradlew pactVerify
```

By default, this will look for Pact files in `../wms-contracts/pact/rest/wms_order_management` relative to the project root. If you want to specify a different location:

```bash
./gradlew pactVerify -PpactFolderPath=/path/to/pact/files
```

To see detailed output when running tests:

```bash
./gradlew pactVerify --info
```

## Database Setup

The verification tests use:
- PostgreSQL in TestContainers
- Liquibase migration scripts from wms-main
- Test data defined in wms-main/liquibase/db/changelog-test.xml

The connection between the test environment and Liquibase is established through:
1. System property overrides (pact.rootDir, spring.liquibase.change-log)
2. Additional classpath entries (LIQUIBASE_TEST_CLASSPATH)

## CI/CD Integration

The Pact verification is integrated into the CI/CD pipeline in the `pre-code-review.yml` workflow. It runs as a separate job that:

1. Checks out the main codebase
2. Checks out the wms-main repo for Liquibase scripts
3. Checks out the wms-contracts repo for Pact files
4. Runs the Pact verification tests

## Provider States

Provider states are used to set up the right conditions for testing. The following provider states are supported:

- `order exists` - Sets up test data for an existing order

Add more provider states in the `OrderManagementContractVerificationTest` class as needed by implementing additional methods with the `@State` annotation.

## Adding New Contract Tests

When adding new contract tests:

1. Make sure the consumer (e.g., UI) generates proper Pact files
2. Place these files in the appropriate directory (`wms-contracts/pact/rest/wms_order_management`)
3. If new provider states are needed, add them to the test class
4. Run the verification tests to ensure the provider fulfills the contract

## Debugging Failures

If you encounter failures in the Pact verification:

1. Check the test output for detailed error messages
2. Verify that the API matches what's expected in the contract
3. Check that any required provider states are correctly implemented
4. Make sure the database is properly set up with the required test data
5. For Liquibase issues, check that the wms-main repository is properly checked out

## Future Improvements

Potential future improvements:
- Add support for static stubs generated by the order management itself
- Integrate with a Pact Broker for publishing verification results
- Extend the test coverage with more comprehensive provider states 